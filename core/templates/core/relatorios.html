{% extends 'core/base.html' %}

{% block title %}Relatórios Gerenciais{% endblock %}

{% block content %}
<style>
    /* ESTILO APENAS PARA IMPRESSÃO */
    @media print {
        /* 1. Esconde tudo que não é o relatório */
        .sidebar,           /* Menu Lateral */
        .navbar,            /* Barra do Topo */
        .no-print,          /* Botões e Filtros marcados */
        form,               /* Formulário de filtro */
        .btn,               /* Botões */
        hr {
            display: none !important;
        }

        /* 2. Ajusta o layout para folha A4 */
        body, html, .main-wrapper, .content {
            background-color: white !important;
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: visible !important;
        }

        /* 3. Remove sombras e bordas dos cards para parecer papel */
        .card {
            border: none !important;
            box-shadow: none !important;
            margin-bottom: 0 !important;
        }

        /* 4. Garante que o conteúdo ocupe toda a largura */
        .container-fluid, .row, .col-md-12 {
            width: 100% !important;
            max-width: 100% !important;
            padding: 0 !important;
        }

        /* 5. Força tabelas a terem bordas pretas nítidas */
        table {
            border-collapse: collapse !important;
            width: 100% !important;
        }
        th, td {
            border: 1px solid #000 !important;
            padding: 8px !important;
            color: #000 !important;
        }
        
        /* 6. Quebra de página inteligente (não corta linha no meio) */
        tr { page-break-inside: avoid; }
        
        /* Ajuste final de posição */
        #area-impressao {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
    }
</style>

<div class="container-fluid">
    <h3 class="mb-4 no-print"><i class="bi bi-graph-up-arrow"></i> Central de Relatórios</h3>

    <div class="card shadow-sm mb-4 no-print">
        <div class="card-body bg-light">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Tipo de Relatório</label>
                    <select name="tipo" class="form-select">
                        <option value="vendas" {% if tipo == 'vendas' %}selected{% endif %}>Vendas Detalhadas</option>
                        <option value="financeiro" {% if tipo == 'financeiro' %}selected{% endif %}>Financeiro (D.R.E.)</option>
                        <option value="produtos" {% if tipo == 'produtos' %}selected{% endif %}>Produtos Mais Vendidos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Data Início</label>
                    <input type="date" name="data_ini" class="form-control" value="{{ data_ini }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Data Fim</label>
                    <input type="date" name="data_fim" class="form-control" value="{{ data_fim }}">
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary w-100"><i class="bi bi-filter"></i> Gerar</button>
                    <button type="button" onclick="window.print()" class="btn btn-dark"><i class="bi bi-printer"></i></button>
                </div>
            </form>
        </div>
    </div>

    <div id="area-impressao" class="card shadow-lg">
        <div class="card-body p-4">
            
            <div class="text-center mb-5">
                <h2 class="fw-bold text-uppercase">{{ user.empresa.nome_fantasia }}</h2>
                <p class="text-muted mb-0">CNPJ: {{ user.empresa.cnpj }}</p>
                <hr class="my-3">
                <h5>Relatório de <strong class="text-uppercase text-primary">{{ tipo }}</strong></h5>
                <p class="small">
                    Período: <strong>{{ data_ini|date:"d/m/Y" }}</strong> até <strong>{{ data_fim|date:"d/m/Y" }}</strong>
                    <span class="ms-3">Gerado em: {% now "d/m/Y H:i" %}</span>
                </p>
            </div>

            {% if tipo == 'vendas' %}
                <div class="row mb-4 border p-3 rounded bg-light-subtle">
                    <div class="col-md-6 text-center border-end">
                        <small class="text-muted text-uppercase">Total Vendido</small>
                        <h2 class="fw-bold text-success">R$ {{ total_periodo }}</h2>
                    </div>
                    <div class="col-md-6 text-center">
                        <small class="text-muted text-uppercase">Quantidade de Vendas</small>
                        <h2 class="fw-bold">{{ qtd_vendas }}</h2>
                    </div>
                </div>

                <h6 class="text-uppercase fw-bold mt-4 mb-2">Resumo por Forma de Pagamento</h6>
                <table class="table table-bordered table-sm mb-4">
                    <thead class="table-light"><tr><th>Meio de Pagamento</th><th class="text-center">Qtd</th><th class="text-end">Total</th></tr></thead>
                    <tbody>
                        {% for item in por_pagamento %}
                        <tr>
                            <td>{{ item.forma_pagamento__nome }}</td>
                            <td class="text-center">{{ item.qtd }}</td>
                            <td class="text-end">R$ {{ item.total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <h6 class="text-uppercase fw-bold mt-4 mb-2">Detalhamento das Vendas</h6>
                <table class="table table-striped table-sm">
                    <thead><tr><th>Data/Hora</th><th>Venda #</th><th>Vendedor</th><th>Cliente</th><th class="text-end">Total</th></tr></thead>
                    <tbody>
                        {% for v in vendas %}
                        <tr>
                            <td>{{ v.data_venda|date:"d/m/Y H:i" }}</td>
                            <td>#{{ v.id }}</td>
                            <td>{{ v.vendedor.username }}</td>
                            <td>{{ v.cliente.nome|default:"Balcão" }}</td>
                            <td class="text-end">R$ {{ v.valor_total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}

            {% if tipo == 'financeiro' %}
                <div class="row text-center mb-4 p-3 border rounded">
                    <div class="col-4 border-end">
                        <h5 class="text-success mb-0">Receitas</h5>
                        <h4 class="fw-bold text-success">+ R$ {{ total_receitas }}</h4>
                    </div>
                    <div class="col-4 border-end">
                        <h5 class="text-danger mb-0">Despesas</h5>
                        <h4 class="fw-bold text-danger">- R$ {{ total_despesas }}</h4>
                    </div>
                    <div class="col-4">
                        <h5 class="mb-0">Lucro Líquido</h5>
                        <h3 class="fw-bold {% if lucro >= 0 %}text-success{% else %}text-danger{% endif %}">
                            R$ {{ lucro }}
                        </h3>
                        <small class="text-muted">Margem: {{ margem|floatformat:1 }}%</small>
                    </div>
                </div>
                
                <h6 class="text-uppercase fw-bold mt-4 mb-2">Extrato Financeiro</h6>
                <table class="table table-striped table-bordered table-sm">
                    <thead class="table-light"><tr><th>Vencimento</th><th>Descrição</th><th>Tipo</th><th class="text-end">Valor</th></tr></thead>
                    <tbody>
                        {% for l in lancamentos %}
                        <tr>
                            <td>{{ l.data_vencimento|date:"d/m/Y" }}</td>
                            <td>
                                {{ l.titulo }}
                                {% if l.data_pagamento %}
                                    <small class="text-muted d-block">Pago em: {{ l.data_pagamento|date:"d/m/Y" }}</small>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if l.tipo == 'RECEITA' %}<span class="badge bg-success border border-success text-success bg-opacity-10">Entrada</span>
                                {% else %}<span class="badge bg-danger border border-danger text-danger bg-opacity-10">Saída</span>{% endif %}
                            </td>
                            <td class="text-end">R$ {{ l.valor }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}

            {% if tipo == 'produtos' %}
                <table class="table table-hover table-bordered table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Produto</th>
                            <th class="text-center">Qtd Vendida</th>
                            <th class="text-end">Faturamento Gerado</th>
                            <th class="text-center">Estoque Atual</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in ranking_produtos %}
                        <tr>
                            <td class="text-center fw-bold">{{ forloop.counter }}</td>
                            <td>{{ item.produto__nome }}</td>
                            <td class="text-center fw-bold">{{ item.qtd_vendida }}</td>
                            <td class="text-end">R$ {{ item.total_vendido }}</td>
                            <td class="text-center">{{ item.produto__estoque_atual }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center py-4">Nenhuma venda neste período.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}

            <div class="mt-5 pt-3 border-top text-center small text-muted">
                <p>Relatório gerado pelo Sistema SaaS - Documento Interno</p>
            </div>

        </div>
    </div>
</div>
{% endblock %}