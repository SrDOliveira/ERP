{% extends 'core/base.html' %}

{% block title %}Painel Mestre SaaS{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3 class="mb-4 fw-bold">Painel de Controle Nova Codium</h3>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <h3>{{ total_lojas }}</h3>
                    <span>Total de Clientes</span>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <h3>{{ lojas_ativas }}</h3>
                    <span>Lojas Ativas</span>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card {% if chamados_abertos > 0 %}bg-danger{% else %}bg-secondary{% endif %} text-white h-100">
                <div class="card-body">
                    <h3>{{ chamados_abertos }}</h3>
                    <span>Chamados Pendentes</span>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#empresas" type="button">Gerenciar Lojas</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#suporte" type="button">
                Suporte Técnico 
                {% if chamados_abertos > 0 %}<span class="badge bg-danger ms-2">{{ chamados_abertos }}</span>{% endif %}
            </button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="empresas">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Loja</th>
                                <th>Plano</th>
                                <th>Vencimento</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in empresas %}
                            <tr>
                                <td class="fw-bold">{{ e.nome_fantasia }}</td>
                                <td><span class="badge bg-info text-dark">{{ e.get_plano_display }}</span></td>
                                <td>{{ e.data_vencimento|date:"d/m/Y"|default:"--" }}</td>
                                <td>
                                    {% if e.ativa %}
                                        <span class="badge bg-success">ATIVA</span>
                                    {% else %}
                                        <span class="badge bg-danger">BLOQUEADA</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'gerar_contrato_pdf' e.id %}" target="_blank" class="btn btn-sm btn-outline-primary" title="Contrato"><i class="bi bi-file-text"></i></a>
                                    <a href="{% url 'alternar_status_loja' e.id %}" class="btn btn-sm btn-outline-dark" title="Bloquear/Liberar"><i class="bi bi-lock"></i></a>
                                    <a href="/admin/core/empresa/{{ e.id }}/change/" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i></a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="suporte">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Assunto</th>
                                <th>Status</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in chamados %}
                            <tr>
                                <td>{{ c.data_abertura|date:"d/m H:i" }}</td>
                                <td>
                                    <strong>{{ c.usuario.empresa.nome_fantasia }}</strong><br>
                                    <small class="text-muted">{{ c.usuario.first_name }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark border">{{ c.get_tipo_display }}</span>
                                    {{ c.assunto }}
                                </td>
                                <td>
                                    {% if c.status == 'ABERTO' %}
                                        <span class="badge bg-danger">ABERTO</span>
                                    {% else %}
                                        <span class="badge bg-success">RESOLVIDO</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'responder_chamado' c.id %}" class="btn btn-sm btn-primary">
                                        {% if c.status == 'ABERTO' %}Responder{% else %}Ver{% endif %}
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center p-4">Nenhum chamado registrado.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}